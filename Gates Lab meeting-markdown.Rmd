---
title: "An introduction to R markdown"
author: "C Wall"
date: "9/18/2018"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
---
```{r setup chunk, setup, include = FALSE}
# can set global directory like this....knitr::opts_knit$set(root.dir = '~/file/file') 
# instead, use R projects and all your files will be in the location of your Project... see here
getwd()
```

## This is an R Markdown!

R markdown is great, and when I say great, **I mean REALLY great.** 
Here, you can write code and execute functions just the same as you would in a normal R script file. However, the added benefit of using markdown is that you can export your script with...   
  *(1) figures embedded*  
  *(2) view tables*  
  *(3) export models*  
  *(4) archive your data pipeline*  
  
The benefit of using markdown with colleagues is they can actually see the script, the figures, the path of model selection, even the assumptions of ANOVA (QQ plots, etc) that normally are hidden behind the curtain.  
  
In short, **R markdown helps make your science repeatable, sharable, and data analysis coherent!**  
  
Here are some common commands and examples of what Markdown can do for you.


## Common Commands 

*Notice the script at the very top of your markdown (this is not standard, but is customized)*  
`
output:  
  html_document:  
  code_folding: hide  
  toc: yes  
  toc_depth: 4  
  toc_float: yes  `  

Let's go through this line by line...  
  
`html_document` is an option you originally set when you open the markdown. This is how your file will be exported.  

`code_folding: hide` will allow you to *show* or *hide* all code (option at top of file)  
`toc` is for table of contents on the left  
`toc_depth` is how long you will have table of contents before folding over  
`toc_float` lets your contents move as you advance in your document.  
  
*Play around with these options, and see how they affect your code*  

  
### Other Markdown essentials  
  
**bold**  
*italics*  
a line break--is executed by two spaces at the end of previous line, and a return  
use '#' for headings, # ## ### ####.... # is largest and #### smallest

` r setup `  This is your set up code and is a useful way to get around the fact that knitr will look for your .Rmd file and all files in the this directory. By setting the root.dir you can force knitr to look for files in the directory you specify and the folders within.    

`include=FALSE`  This command makes your code absent from final html, essentially it is 'not included'  

`eval=FALSE`  This command allows you to show the code in your script within R studio, but not evaluate (or run) the code. It is effectively silent in your analysis and output html.

`echo=FALSE`  This will show the output but not the code chunk...  notice the difference.

`results='hide'` This will hide output, or any returned results from your commands  
  
`fig.show=FALSE` This will hide the figures you generate. This may be useful for some of those assumptions of ANOVA-- you want to see it, but do you want all of them in your final archived datafile? Maybe not.  

## Code chunks
```{r}
## love your data and it will love you back
getwd()
``` 
Code chunks are where your code is executed. If you do not set the working directory in *setup* each code chunk will revert to its original directory, or where your .Rmd file lives.   Below: This is a code chunk, and this is how you enter your data into R markdown. Note the `code chunks` always start with a ` ```{r...` and ends with a `...}`  
  
The code chunk below is an example of attaching the data (.csv), familiar to you R-heads. Since the data file is in the directory specified by ` knitr::opts_knit$set(root.dir =... ` above, you can reference the .csv easily.


```{r}
################################################
# import data, observe structure
################################################

# data file is in the folder 'data', within main working directory
data<-read.csv("data/coral_data.csv")
names(data)
```
## Including figures
In this chunk we will make a figure of chlorophyll *a* concentrations cm^-2^.  Some of the syntax here should be familiar.

```{r, message=FALSE, results='hide'}
# message = FALSE to hide any messages with exporting the figure with dev.off(), or anything else that R may generate. If you set warning=FALSE, warnings will be hidden as well. 

par(mfrow=c(1,1), pty="sq")
Status.label<-c("Bleached", "Pigmented") # for x labels

plot(chla~Status, data=data, xaxt="n",
     ylab=expression(paste("Chlorophyll", ~italic("a"), ~(mu*g~cm^-2), sep="")), 
     xlab="Coral Physiological State", 
     main="Example Figure")
axis(1, at=1:2, labels=Status.label) # this plots new labels on the x axis (axis = 1)

##### save the figure and export to directory? ####
# in this case, there is a file in my directory names 'figures' where I want plots to go

dev.copy(pdf, "figures/Chlorophyll.pdf", encod="MacRoman", height=5, width=5) 
# height and width set here for the output figure
dev.off() # close the object
```
  
If you change export to the same location as your working directory and not a subfile ``chlorophyll.pdf``` will do the job.


#### Examples

- see a code chunk in my markdown file, but it isn't executed if `eval=FALSE` is set
```{r, eval=FALSE}
mean(data$chla)
```

- execute the code and hide results `results='hide'`
```{r, results='hide'}
chla.transform<-sqrt(data$chla)
mean(chla.transform)
```
  
- execute and show code and SEE the figure I generate, but hide results (returned data)  
  `results='hide', fig.height=4, fig.width=4, fig.align='center'`
```{r, results='hide', fig.height=4, fig.width=4, fig.align='center'}
mean(chla.transform)

# make figure 4 x 4 and center align
plot(chla.transform~Site, data=data)
```

... or just print the figure with `echo=FALSE` sans the code
```{r, echo=FALSE, fig.height=4, fig.width=4, fig.align='center'}
plot(chla.transform~Site, data=data)
# make figure 4 x 4 and center align
```

... or show NOTHING with `results='hide', fig.show=FALSE`
```{r, results='hide', fig.show='hide'}
plot(chla.transform~Site, data=data)
```

### Make a table of summary data
plot raw data 'as is'
```{r, 'as.is'}
knitr::kable(data[c(1:5), c(1:10)])
```
  
Or make summary data and include this table in your markdown
```{r}
chl.mean<-aggregate(chla~Time.point + Site + Species + Status, data, mean)
biomass.mean<-aggregate(biomass~Time.point + Site + Species + Status, data, mean)
data.table<-cbind(chl.mean[, c(1:5)], biomass.mean[,5])
colnames(data.table)<-c("Time Point", "Site", "Species", "Status", "mean chla", "mean AFDW")
knitr::kable(data.table)
```

## Running models

markdown makes running models easy. You can leave all candidate models in the script or you can only report final models. In either case, it is an easy way to keep your data from analysis easy to understand and to QA/QC before publication

**chlorophyll a model**
Load packages and look at structure
```{r, results= "hide"}
library("lme4")
library("lmerTest")
library('effects')

str(data)
data$Sample.ID<-as.factor(data$Sample.ID)
```
  
Run a linear mixed effect model, see the anova output, random effects, and plot effects
```{r}
mod<-lmer(chla~Species*Site*Status+(1|Pair), data=data)
anova(mod, type=2)
rand(mod)
plot(allEffects(mod), ylab="total chlorophyll/cm2")
```